function ve(){String.prototype.startsWith||(String.prototype.startsWith=function(r,e){return e=!e||e<0?0:+e,this.substring(e,e+r.length)==r}),String.prototype.endsWith||(String.prototype.endsWith=function(r,e){return(e==null||e>this.length)&&(e=this.length),this.substring(e-r.length,e)==r})}function he(r){return r!=null&&(typeof r=="string"||toString.call(r)=="[object String]")}function w(r){return r!=null&&(typeof r=="number"||toString.call(r)=="[object Number]")}function be(r){return r!=null&&(typeof r=="boolean"||toString.call(r)=="[object Boolean]")}function x(r){return r!=null&&Array.isArray(r)}function S(r){return r!=null&&toString.call(r)=="[object Object]"}function ye(r){let e=toString.call(r);return e=="[object Function]"||e=="[object AsyncFunction]"||e=="[object GeneratorFunction]"||e=="[object Proxy]"}var Ee=[{name:"assign",evaluate:(...r)=>Object.assign({},...r)},{name:"map",evaluate:(r,e)=>r.map(e)},{name:"sort",evaluate:(r,e)=>e?r.slice().sort((t,i)=>{let o=e(t),a=e(i);return o>a?1:-1}):r.slice().sort()},{name:"reverse",evaluate:r=>r.slice().reverse()},{name:"indexOf",evaluate:(r,e)=>{if(x(r))return r.indexOf(e)}},{name:"findIndex",evaluate:(r,e)=>{if(x(r)&&e)return r.findIndex(e)}},{name:"filter",evaluate:(r,e)=>{if(x(r))return r.filter(e);if(S(r))return Object.keys(r).reduce((t,i)=>(e(i,r[i])&&(t[i]=r[i]),t),{})}},{name:"reduce",evaluate:(r,e,t)=>r.reduce(e,t)},{name:"find",evaluate:(r,e)=>r.find(e)},{name:"slice",evaluate:(r,e,t)=>r.slice(e,t)},{name:"splice",evaluate:(r,e,t,...i)=>{let o=r.slice();return o.splice(e,t,...i),o}},{name:"concat",evaluate:(r,...e)=>{r==null?r=[]:x(r)||(r=[r]),e=e.filter(t=>t!=null);for(let t=0;t<e.length;t++)x(e[t])||(e[t]=[e[t]]);return r.concat(...e)}},{name:"min",evaluate:(r,e)=>{let t=null;return r.forEach(i=>t=Te(t,e?e(i):i)),t}},{name:"findMin",evaluate:(r,e)=>{let t=null,i=null;return r.forEach(o=>{let a=e?e(o):o;t=Te(t,a),a===t&&(i=o)}),i}},{name:"max",evaluate:(r,e)=>{let t=null;return r.forEach(i=>t=ke(t,e?e(i):i)),t}},{name:"findMax",evaluate:(r,e)=>{let t=null,i=null;return r.forEach(o=>{let a=e?e(o):o;t=ke(t,a),a===t&&(i=o)}),i}},{name:"avg",evaluate:(r,e)=>{let t=0,i=0;return r.forEach(o=>{let a=e?e(o):o;if(a!=null){if(!w(a))throw new Error("Values for evaluator 'avg' must be numeric or null.");t+=a,i++}}),i?t/i:null}},{name:"length",evaluate:r=>r.length},{name:"range",evaluate:(r,e,t)=>{let i=[];for(let o=r;o<e;o+=t||1)i.push(o);return i}},{name:"item",evaluate:(r,e)=>r[e]},{name:"first",evaluate:r=>r!=null&&r.length>0?r[0]:void 0},{name:"last",evaluate:r=>r!=null&&r.length>0?r[r.length-1]:void 0}];function Te(r,e){return r==null&&e==null?null:r==null?e:e==null?r:e<r?e:r}function ke(r,e){return r==null&&e==null?null:r==null?e:e==null?r:e>r?e:r}var we=[{name:"eq",evaluate:(r,e)=>r==e,operator:{symbol:"==",precedence:2}},{name:"eqq",evaluate:(r,e)=>r===e,operator:{symbol:"===",precedence:2}},{name:"neq",evaluate:(r,e)=>r!=e,operator:{symbol:"!=",precedence:2}},{name:"neqq",evaluate:(r,e)=>r!==e,operator:{symbol:"!==",precedence:2}},{name:"gt",evaluate:(r,e)=>r>e,operator:{symbol:">",precedence:2}},{name:"gte",evaluate:(r,e)=>r>=e,operator:{symbol:">=",precedence:2}},{name:"lt",evaluate:(r,e)=>r<e,operator:{symbol:"<",precedence:2}},{name:"lte",evaluate:(r,e)=>r<=e,operator:{symbol:"<=",precedence:2}}];var Ne=[{name:"add",evaluate:(r,e)=>r+e,operator:{symbol:"+",precedence:3}},{name:"sub",evaluate:(r,e)=>r-e,operator:{symbol:"-",precedence:3}},{name:"mul",evaluate:(r,e)=>r*e,operator:{symbol:"*",precedence:3.1}},{name:"div",evaluate:(r,e)=>r/e,operator:{symbol:"/",precedence:3.1}},{name:"mod",evaluate:(r,e)=>r%e,operator:{symbol:"%",precedence:3.1}},{name:"pow",evaluate:(r,e)=>Math.pow(r,e),operator:{symbol:"**",precedence:3.2,assoc:"right"}},{name:"neg",evaluate:r=>-r,operator:{symbol:"-u",precedence:0,isUnary:!0}}];var Se=[{name:"ifElse",deferEvaluation:!0,evaluate:(r,e,t)=>r.evaluate()?e==null?void 0:e.evaluate():t==null?void 0:t.evaluate()},{name:"ifNull",evaluate:(r,e,t)=>r===null?e:t===void 0?r:t},{name:"ifUndefined",evaluate:(r,e,t)=>r===void 0?e:t===void 0?r:t},{name:"ifNullOrUndefined",evaluate:(r,e,t)=>r==null?e:t===void 0?r:t}];var De=[{name:"or",evaluate:(r,e)=>r||e,operator:{symbol:"||",precedence:1}},{name:"and",evaluate:(r,e)=>r&&e,operator:{symbol:"&&",precedence:1.1}},{name:"not",evaluate:r=>!r,operator:{symbol:"!",precedence:1.2,isUnary:!0,assoc:"left"}},{name:"notNot",evaluate:r=>!!r,operator:{symbol:"!!",precedence:1.2,isUnary:!0,assoc:"left"}},{name:"funny",evaluate:r=>r==1,operator:{symbol:"?",precedence:0,isUnary:!0,assoc:"right"}}];function Oe(r){return r.split(" ").map(e=>e.trim()).filter(e=>!!e)}function We(r){let e=[""],t;for(let i=0;i<r.length;i++){let o=r[i],a=/[^a-zA-Z0-9]/.test(o);e[e.length-1]&&(a||t&&t==t.toLowerCase()&&o==o.toUpperCase())&&e.push(""),a||(e[e.length-1]+=o.toLowerCase()),t=o}return e.filter(i=>!!i)}var Re=[{name:"toString",evaluate:(r,e)=>r.toString(e!=null?e:10)},{name:"substr",evaluate:(r,e,t)=>r.substr(e,t)},{name:"substring",evaluate:(r,e,t)=>r.substring(e,t)},{name:"startsWith",evaluate:(r,e)=>r.startsWith(e)},{name:"endsWith",evaluate:(r,e)=>r.endsWith(e)},{name:"contains",evaluate:(r,e)=>r.indexOf(e)>=0},{name:"split",evaluate:(r,e)=>r.split(e)},{name:"join",evaluate:(r,e)=>r.join(e)},{name:"toUpperCase",evaluate:r=>r.toUpperCase()},{name:"toLowerCase",evaluate:r=>r.toLowerCase()},{name:"toTitleCase",evaluate:r=>Oe(r).map(e=>e[0].toUpperCase()+e.substr(1)).join(" ")},{name:"toSnakeCase",evaluate:r=>Oe(r).join("_")},{name:"toCamelCase",evaluate:r=>{let e=We(r),t="";for(let i=0;i<e.length;i++)!e[i]||(i!=0&&(e[i]=e[i][0].toUpperCase()+e[i].substr(1)),t+=e[i]);return t}},{name:"trim",evaluate:r=>r.trim()},{name:"trimLeft",evaluate:r=>r.trimLeft()},{name:"trimRight",evaluate:r=>r.trimRight()},{name:"replace",evaluate:(r,e,t)=>r.split(e).join(t||"")}];var _=class extends Error{constructor(t,i,o){super(i);this._name=t,this._message=i,this.sourceRef=o}get name(){return this._name}get message(){return this._message}toString(){return this.message}getReferenceString(){let t="";if(this.sourceRef){let i=this.sourceRef.symbol?`"${this.sourceRef.symbol}"`:"";t=`${this.sourceRef.line}:${this.sourceRef.index}`}return t}},g=class extends _{constructor(e,t){super("Syntax error",e,t)}},v=class extends _{constructor(e,t){super("Compilation error",e,t)}};var Ae=[{name:"notNull",evaluate:r=>{if(r==null)throw new v("Value cannot be null.");return r}},{name:"throw",deferEvaluation:!0,evaluate:r=>{let e=r.evaluate();throw new v(e,r.sourceRef)}},{name:"catch",deferEvaluation:!0,evaluate:(r,e)=>{try{return r.evaluate()}catch{return e?e.evaluate():null}}}];var Ce=Object.getOwnPropertyNames(Math).map(r=>{let e=Math[r],t=ye(e)?(...i)=>e(...i):w(e)?()=>e:null;return{name:"math~"+r,evaluate:t}}).filter(r=>r.evaluate!=null);var E=class{constructor(e=null){this.owner=e,this.variables={}}getVariable(e){let t=[],i=this;for(;i!=null;){ze(i.owner)&&t.push(i.owner);let o=i.variables[e];if(o!=null)return o.addDependents(t),o;i=i.parentScope}}setVariable(e){if(e==null)throw new Error("Cannot set null variable.");let t=this.variables[e.varName];t!=null&&t.clearCache(),e.bindScope(this),this.variables[e.varName]=e}clearVariables(){for(let e of Object.keys(this.variables))this.variables[e].clearCache();this.variables={}}bind(){for(let e of Object.keys(this.variables))this.variables[e].bindScope(this)}};function ze(r){return r==null?!1:r._fxScopeVariableExpressionType==="__FxScopeVariableExpression"}var u=class{constructor(){this._scope=new E(this),this.sourceRef={symbol:"",index:-1,path:""}}get children(){return[]}get scope(){return this._scope}evaluate(){}bindScope(e=null){this.scope.parentScope!=e&&(this.scope.parentScope=e,this.scope.bind());for(let t of this.children)t.bindScope(this.scope)}toString(){return this.constructor.name}};var D=class extends u{constructor(t){super();this.items=t||[]}get children(){return this.items}evaluate(){return this.items.map(t=>t.evaluate())}toString(){return`[${this.items.map(t=>t.toString())}]`}};var l=class{get tag(){}get operator(){}get evaluator(){}get validator(){return this.validate.bind(this)}get optimizer(){return this.optimize.bind(this)}get compiler(){return e=>{let t=this.compile(e);return t.sourceRef=e.sourceRef,t}}optimize(e){}validate(e){}compile(e){return null}};var $=class extends l{get tag(){return"group"}optimize(e){e.parent&&e.count<=1&&e.unwrap()}compile(e){return e.parent?new D(e.children.map(t=>t.compile())):e.first.compile()}};var f=class extends u{constructor(t,i){super();this.evaluator=t||null,this.args=i||[],this.deferEvaluation=!1}get children(){return this.args}evaluate(){let t=this.evaluateArgs();return this.evaluator(...t)}evaluateArgs(){return this.deferEvaluation?this.args:this.args.map(t=>t.evaluate())}toString(){let t=this.sourceRef.symbol;return this.args.length>0&&(t+=`(${this.args.map(i=>i.toString()).join(", ")})`),t}};var d=class extends u{constructor(t){super();this.value=t}replaceValue(t){this.value=t}evaluate(){return this.value}toString(){return this.value==null?"(null)":this.value.toString()}};var O=class extends l{get tag(){return"expression"}compile(e){let t=e.evaluator;if(!t)throw new v(`Expression "${e.symbol}" is undefined`,null);let i=new f(t.evaluate);return i.args=e.children.map(o=>o.compile()),i.deferEvaluation=t.deferEvaluation,i}},R=class extends O{get tag(){return"identifier"}compile(e){return e.evaluator?super.compile(e):new d(R.parseConstant(e.symbol))}static parseConstant(e){switch(e){case"true":return!0;case"false":return!1;case"null":return null;case"undefined":return;default:return e}}},U=class extends O{get tag(){return"operator"}},M=class extends l{get tag(){return"indexer"}compile(e){let t=e.first,i=e.last;return i.is("group")?new f((o,...a)=>a.map(p=>o[p]),[t.compile(),...i.children.map(o=>o.compile())]):new f((o,a)=>o[a],[t.compile(),i.compile()])}},q=class extends l{get tag(){return"key-indexer"}compile(e){let t=e.first,i=e.last,o=[t.compile()];return i.is("group")?o.push(...i.children.map(a=>a.compile())):o.push(i.compile()),new f((a,...p)=>{let m={};for(let y of p)m[y]=a[y];return m},o)}};var K=class extends u{constructor(){super();this.fields=[]}get children(){return this.output?[this.output]:this.fields.concat()}addField(t){this.fields.push(t)}evaluate(){let t={};if(this.output){if(this.fields.length>0)throw new v('Object with yield key "()" may only define variable and template keys',this.sourceRef);return this.output.evaluate()}for(let i of this.fields)i.evaluate().forEach(o=>t[o.key]=o.value);return t}toString(){let t=Object.keys(this.scope.variables).map(o=>`${o}: ${this.scope.variables[o].toString()}`),i=this.fields.map(o=>o.toString());return i=t.concat(i),`{${i.join(", ")}}`}};var A=class{constructor(){this._parent=null,this._children=[]}get parent(){return this._parent}set parent(e){this._parent=e}get children(){return this._children.concat()}get count(){return this._children.length}get first(){return this._children[0]||null}get last(){return this._children[this._children.length-1]||null}add(e,t){e&&(t=this.toIndex(t),t!=-1?this._children.splice(t,0,e):this._children.push(e),e.orphan(),e._parent=this)}remove(e){e=this.toIndex(e);let t;return e!=-1?t=this._children.splice(e,1)[0]:t=this._children.pop(),t._parent=null,t}orphan(){this._parent&&this._parent.remove(this)}wrap(e){this._parent&&this._parent.add(e,this),e.add(this)}unwrap(){if(this._parent)for(;this._children.length>0;)this._parent.add(this.first,this);this.orphan()}toIndex(e){return e==null?-1:e instanceof A?(e=this._children.indexOf(e),e!=-1?e:-1):e>=0&&e<this._children.length?e:-1}};var c=class extends A{constructor(t,i,o,a){super();this.tag=t||"",this.symbol=i||"",this.sourceRef={line:o,index:a,symbol:this.symbol,path:""},this.definition={}}get operator(){return this.definition.operator||null}set operator(t){this.definition.operator=t}get evaluator(){return this.definition.evaluator||null}set evaluator(t){this.definition.evaluator=t}optimize(){for(let t of this.children)t.optimize();this.definition.optimizer&&this.definition.optimizer(this)}validate(){for(let t of this.children)t.validate();this.definition.validator&&this.definition.validator(this)}compile(){if(this.definition.compiler)return this.definition.compiler(this);throw new Error(`Token ${this.toString()} has no compiler defined`)}is(t,i){return t=x(t)?t:[t],i=!i||x(i)?i:[i],t.includes(this.tag)&&(!i||i.includes(this.symbol))}below(t,i){let o=this.parent;for(;o;){if(o.is(t,i))return!0;o=o.parent}return!1}static from(t){let i=new c(t.tag,t.symbol,t.line,t.index);if(t.children)for(let o of t.children)i.add(c.from(o));return i}toString(t,i){t=!!t,i=i!=null?i:0;let o=(this.symbol!=""?this.symbol:"<>")+` [${this.tag}]`;return t&&(o=(i>0?"\u2502 ".repeat(i-1)+"\u251C\u2500":"")+o,this.count>0&&(o+=`
`+this.children.map(p=>p.toString(!0,i+1)).join(`
`))),o}};var T=class extends u{constructor(t,i,o){super();this._fxScopeVariableExpressionType="__FxScopeVariableExpression";this.dependents=[];this.isCached=!1;this.varName=t,this.inner=i,this.canCache=o}evaluate(){return this.inner==null?null:this.canCache?(this.isCached||(this.cachedValue=this.inner.evaluate(),this.isCached=!0),this.cachedValue):this.inner.evaluate()}clearCache(){this.isCached=!1,this.cachedValue=void 0;for(let t of this.dependents)t.clearCache()}bindScope(t=null){super.bindScope(t),this.inner!=null&&this.inner.bindScope(this.scope)}addDependents(t){for(let i of t)this.dependents.indexOf(i)<0&&this.dependents.push(i)}},Q=class extends T{constructor(t,i){super(t,new d(i),!0);this.value=i;this.constant=this.inner}replaceValue(t){this.constant.replaceValue(t),this.clearCache()}};var k=class extends u{constructor(t,i){super();this.varNames=t,this.expression=i}get children(){return[this.expression]}evaluate(){return this.evaluator.bind(this)}evaluator(...t){for(let i=0;i<this.varNames.length;i++)t[i]!=null?this.scope.setVariable(new T(this.varNames[i],new d(t[i]),!1)):this.scope.setVariable(new T(this.varNames[i],void 0,!1));return this.expression.evaluate()}toString(){return`(${this.varNames.join(", ")}) => ${this.expression.toString()}`}};var C=class extends l{get operator(){return{symbol:"=>",precedence:0}}optimize(e){if(e.first.tag!="group"){let t=new c("args");e.first.wrap(t)}else e.first.tag="args"}compile(e){let t=e.first.children.map(i=>i.symbol);return new k(t,e.last.compile())}};var I=class extends u{};var B=class extends I{constructor(t,i){super();this.expression=t,this.lambda=i}get children(){return[this.expression,this.lambda]}evaluate(){let t=this.expression.evaluate();return S(t)?Object.keys(t).map(i=>({key:i,value:this.lambda.evaluator(i,t[i])})):x(t)?t.map((i,o)=>({key:i.toString(),value:this.lambda.evaluator(i,o)})):[{key:t.toString(),value:this.lambda.evaluator(t)}]}};var G=class extends I{constructor(t,i){super();this.key=t,this.value=i}get children(){return[this.value]}evaluate(){return[{key:this.key,value:this.value.evaluate()}]}};var H=class extends l{constructor(){super();this.lambda=new C}get tag(){return"object"}validate(t){for(let i of t.children)if(!i.is("operator",":_kv"))throw new g("Invalid object literal, expected key-value pairs",i.sourceRef)}compile(t){let i=new K;for(let o of t.children)if(o.count==1)i.output=o.first.compile();else{let a=o.first,p=o.last;switch(a.tag){case"identifier":case"literal":case"numeric":i.addField(new G(a.symbol,p.compile()));break;case"dynamic":i.addField(new B(a.first.compile(),new k(a.children.slice(1).map(y=>y.symbol),p.compile())));break;case"variable":i.scope.setVariable(new T(a.symbol,p.compile(),!0));break;case"template":case"template-call":let m=a.children.map(y=>y.symbol);i.scope.setVariable(new T(a.symbol,new k(m,p.compile()),!1));break}}return i}};var J=class extends l{get tag(){return"array"}compile(e){let t=e.children.map(i=>i.compile());return new D(t)}};var P=class extends u{constructor(t){super();this.varName=t}evaluate(){let t=this.scope.getVariable(this.varName);if(t==null)throw new v(`Undefined variable "${this.varName}"`,this.sourceRef);return t.evaluate()}toString(){return this.varName}};var W=class extends l{get tag(){return"variable"}compile(e){return new P(e.symbol)}},Z=class extends W{get tag(){return"template"}};var X=class extends l{get tag(){return"literal"}compile(e){return new d(e.symbol)}},Y=class extends l{get tag(){return"numeric"}compile(e){return new d(parseFloat(e.symbol))}};var ee=class extends u{constructor(t){super();this.path=t}get children(){return this.path.map(t=>t.value)}evaluate(){let t=this.path[0].value.evaluate();if(this.path[0].interrupts&&t==null)return null;for(let i=1;i<this.path.length;i++){let o=this.path[i].value.evaluate();if(t=t[o],this.path[i].interrupts&&t==null)return null}return t}};var b=class extends l{get operator(){return{symbol:".",precedence:4}}compile(e){return new ee(b.getPropertyPath(e))}static getPropertyPath(e){if(b.isProp(e)||b.isNullProp(e)){let t={value:new d(e.last.symbol),interrupts:!1},i=[...b.getPropertyPath(e.first),t];return b.isNullProp(e)&&(i[i.length-2].interrupts=!0),i}else return[{value:e.compile(),interrupts:!1}]}static isProp(e){return e.is("operator",[".","?."])}static isNullProp(e){return e.is("operator","?.")}},te=class extends b{get operator(){return{symbol:"?.",precedence:4}}};var re=class extends l{get tag(){return"template-call"}compile(e){let t=new P(e.symbol),i=e.children.map(o=>o.compile());return new f((o,...a)=>o(...a),[t].concat(i))}};var Ie=[{tag:"identifier",test:r=>{let e=r.charCodeAt(0);return e>=65&&e<=90||e>=97&&e<=122||r=="~"||r=="_"},mergeWith:["variable","template"]},{tag:"variable",test:r=>r=="$"},{tag:"space",test:r=>/\s/.test(r)},{tag:"group",test:r=>r=="("||r=="["||r=="{",preventMerge:!0},{tag:"group-close",test:r=>r==")"||r=="]"||r=="}",preventMerge:!0},{tag:"template",test:r=>r=="@"},{tag:"numeric",test:r=>{let e=r.charCodeAt(0);return e>=48&&e<=57},mergeWith:["identifier","variable","template"]},{tag:"operator",test:r=>r==".",mergeWith:"numeric"},{tag:"operator",test:r=>r=="-",preventMerge:!0},{tag:"operator",test:()=>!0}];var ie=class extends l{get operator(){return{symbol:":",precedence:4}}optimize(e){e.last.add(e.first,0),e.unwrap()}},oe=class extends l{get operator(){return{symbol:"?:",precedence:4}}optimize(e){e.last.add(e.first,0)}compile(e){let t=new f;return t.deferEvaluation=!0,t.evaluator=i=>i.args[0].evaluate()==null?null:i.evaluate(),t.args=[e.first.compile()],t}};var Pe=[{name:"now",evaluate:()=>new Date},{name:"dateTime",evaluate:r=>new Date(r)},{name:"toISODateTime",evaluate:r=>new Date(r).toISOString()},{name:"toISOLocalDateTime",evaluate:(r,e)=>_e(new Date(r),e)}];function _e(r,e){e==null&&(e=new Date().getTimezoneOffset());let t=Math.floor(Math.abs(e/60)).toString(),i=Math.abs(e%60).toString();return t.length===1&&(t="0"+t),i.length===1&&(i="0"+i),new Date(Date.now()-e*6e4).toISOString().slice(0,-1)+(e<=0?"+":"-")+t+":"+i}var Ve=[{name:"log",evaluate:(r,e)=>(console.log(r,e),e)}];var h;(p=>(p.SymbolAssign=":_kv",p.SymbolNegative="-u",p.SymbolLiteral="'",p.TokenRules=Ie,p.Functions=[].concat(Ne).concat(Ee).concat(we).concat(Se).concat(De).concat(Re).concat(Pe).concat(Ve).concat(Ae).concat(Ce),p.Intrinsics=[new $,new R,new H,new J,new W,new Z,new U,new O,new M,new q,new X,new Y,new C,new b,new re,new te,new ie,new oe,{operator:{symbol:"as",precedence:-3},validator:m=>{if(!m.below("dynamic"))throw new g('"as" is only valid within a dynamic key declaration',m.sourceRef);m.unwrap()}},{operator:{symbol:",",precedence:-2},optimizer:m=>{m.unwrap()}},{operator:{symbol:":_kv",precedence:-1}},{operator:{symbol:"for",precedence:.2}},{operator:{symbol:"in",precedence:.2},compiler:m=>{let y=m.first.first,me=m.first.last,xe=m.last,N=new k([me.symbol],y.compile());return new f((fe,de)=>fe.map(de),[xe.compile(),N])}},{operator:{symbol:"if",precedence:.1}},{operator:{symbol:"else",precedence:.1},compiler:m=>{let y=m.first.last,me=m.first.first,xe=m.last,N=new f;return N.deferEvaluation=!0,N.args=[y.compile(),me.compile(),xe.compile()],N.evaluator=(fe,de,je)=>fe.evaluate()?de.evaluate():je.evaluate(),N}}]))(h||(h={}));var F=class{constructor(...e){this.operators={},this.definitions={},h.Intrinsics.forEach(t=>this.defineIntrinsic(t)),h.Functions.forEach(t=>this.defineExpression(t));for(let t of e)t.forEach(i=>this.defineExpression(i))}defineIntrinsic(e){let t=F.sanitize({operator:e.operator,evaluator:e.evaluator,optimizer:e.optimizer,validator:e.validator,compiler:e.compiler});e.tag&&(this.definitions[F.hash(e.tag)]=t),e.operator&&this.defineOperator(e.operator.symbol,t)}defineExpression(e){let t=F.sanitize({operator:e.operator,evaluator:e});this.definitions[F.hash(null,e.name)]=t,e.operator&&this.defineOperator(e.operator.symbol,t)}defineOperator(e,t){this.operators[e]=t}getOperator(e){let t=this.operators[e];return t?t.operator:null}getDefinition(e,t){let i,o,a,p;return(t=="operator"||t=="expression"||t=="identifier")&&(i=this.operators[e]),t!="literal"&&t!="numeric"&&(o=this.definitions[F.hash(t,e)],a=this.definitions[F.hash(null,e)]),p=this.definitions[F.hash(t,null)],Object.assign({},p,a,o,i)}static sanitize(e){let t={};if(e)for(let i of Object.keys(e))e[i]!=null&&(t[i]=e[i]);return t}static hash(e,t){return e=e||"*",t=t||"*",`${t} [${e}]`}};var V=class{initialize(){this.tokens=[{symbol:"",tag:"",index:0}],this.isLiteralSequence=!1,this.sourceLine=1,this.sourceIndex=0,this.next="",this.prevToken=this.tokens[0]}parse(e){this.initialize();for(this.next of e)this.parseNextChar(),this.next===`
`?(this.sourceLine++,this.sourceIndex=0):this.sourceIndex++;return this.removeWhitespace(),this.tokens}parseNextChar(){this.isLiteralSequence?this.mergeNextWithLast(null):this.mergeBasedOnRule(),this.prevToken=this.tokens[this.tokens.length-1]||null,this.next==h.SymbolLiteral&&this.toggleLiteralSequence()}removeWhitespace(){this.tokens=this.tokens.filter(e=>e.tag!="space"&&e.tag!="")}mergeBasedOnRule(){let e=this.getNextRule();this.canMergeNextWithLast(e)?this.mergeNextWithLast(e):this.tokens.push({symbol:this.next,tag:e.tag,line:this.sourceLine,index:this.sourceIndex})}getNextRule(){for(let e of h.TokenRules)if(e.test&&e.test(this.next))return V.sanitize(e);return null}canMergeNextWithLast(e){return!this.prevToken.tag||!e.preventMerge&&(e.tag==this.prevToken.tag||e.mergeWith.includes(this.prevToken.tag))}mergeNextWithLast(e){this.prevToken.symbol+=this.next,this.prevToken.tag||(this.prevToken.tag=e.tag)}toggleLiteralSequence(){this.isLiteralSequence=!this.isLiteralSequence,this.prevToken.tag="literal",this.prevToken.symbol=this.prevToken.symbol.replace(h.SymbolLiteral,"")}static sanitize(e){return e.tag=e.tag||"",e.preventMerge=!!e.preventMerge,e.mergeWith?e.mergeWith=x(e.mergeWith)?e.mergeWith:[e.mergeWith]:e.mergeWith=[],e}};var ne=class{parse(e){this.root=new c("group"),this.root.sourceRef.path=this.path||"";for(let t of e)switch(this.current=new c(t.tag,t.symbol,t.line,t.index),this.current.sourceRef.path=this.path||"",this.current.tag){case"group":this.descend();break;case"group-close":this.ascend();break;default:this.root.add(this.current);break}if(!this.rootIsClosed())throw new g(`Unclosed "${this.root.symbol}"`,this.root.sourceRef);return this.root}descend(){this.root.add(this.current),this.root=this.current}ascend(){switch(this.root.symbol+this.current.symbol){case"()":break;case"[]":this.root.tag="array";break;case"{}":this.root.tag="object";break;default:throw new g(`Unexpected "${this.current.symbol}"`,this.current.sourceRef)}this.root=this.root.parent,this.current.orphan()}rootIsClosed(){return!this.root.parent}};var se=class{constructor(){this.tokenizer=new V,this.grouper=new ne,this.path=[]}parse(e){if(he(e))return this.parseString(e);if(w(e))return new c("numeric",e.toString(),0,0);if(be(e))return new c("identifier",e.toString(),0,0);if(e===null)return new c("identifier","null",0);if(x(e))return this.parseArray(e);if(S(e))return this.parseObject(e)}parseString(e){let t=this.tokenizer.parse(e);this.grouper.path=this.composePath();let i=this.grouper.parse(t);return i.count==1?(i=i.first,i.orphan()):i.count==0&&(i=new c("identifier","null")),i}parseArray(e){let t=this.setPath(new c("array","[]"));for(let i=0;i<e.length;i++)this.path.push(i),t.add(this.parse(e[i])),this.path.pop();return t}parseObject(e){let t=this.setPath(new c("object","{}")),i=Object.keys(e);for(let o=0;o<i.length;o++){let a=i[o];if(a.startsWith("//"))continue;let p;a=="()"||a.startsWith("{")||a.startsWith("$")||a.startsWith("@")?p=this.parse(a):p=new c("literal",a),p.count==2&&p.first.is("identifier")&&p.last.is("operator","?")&&(p=p.first,p.symbol+="?"),t.add(p),t.add(this.setPath(new c("operator",":"))),this.path.push(this.getKeyPath(a)),t.add(this.parse(e[a])),this.path.pop(),t.add(this.setPath(new c("operator",",")))}return t.count>0&&t.remove(),t}setPath(e){return e.sourceRef.path=this.composePath(),e}getKeyPath(e){if(e=="()")return e;let t=e.indexOf("(");return t!=-1?e.substr(0,t):e}composePath(){let e="";for(let t=0;t<this.path.length;t++){let i=this.path[t];he(i)?e+=e?"."+i:i:w(i)&&(e+=`[${i}]`)}return e}};var ae=class{constructor(...e){this.parsers=e}parse(e){for(let t of this.parsers)this.parseRecursive(e,t)}parseRecursive(e,t){t.rootFirst&&t.parser.parse(e);for(let i of e.children)this.parseRecursive(i,t);t.rootFirst||t.parser.parse(e)}};var L=class{before(e){}after(){}parse(e){if(this.before(e),e.count>0){let t,i;for(i of e.children)t&&this.parseItem(t,i),i.parent==e&&(t=i);i.parent==e&&this.parseItem(t,null)}this.after()}};var pe=class extends L{constructor(t){super();this.loader=t}before(t){this.parent=t,this.prev=null,this.isNotAssignment=!0}after(){this.parent.parent==null&&this.loadOperator(this.parent)}parseItem(t,i){this.current=t,this.parent.is("object")?this.parseObject():this.isUnaryMinus()&&(this.current.symbol=h.SymbolNegative),this.loadOperator(t),this.prev=t}loadOperator(t){if(t.is(["literal","numeric"]))return;let i=this.loader.getOperator(t.symbol);i&&(t.operator=i,t.tag="operator")}parseObject(){this.current.is("array")&&this.isNotAssignment?(this.current.tag="dynamic",this.current.first&&this.current.first.is("dynamic")&&(this.current.first.tag="object")):this.isAssignment()?(this.current.symbol=h.SymbolAssign,this.isNotAssignment=!1):this.isComma()&&(this.isNotAssignment=!0)}isUnaryMinus(){return this.current.is("operator","-")&&(!this.prev||this.prev.is("operator"))}isAssignment(){return this.current.is("operator",":")&&this.isNotAssignment}isComma(){return this.current.is("operator",",")}};var le=class extends L{before(t){this.parent=t}parseItem(t,i){this.current=t,this.next=i,this.isCall()?this.convertToCall():this.isIndexer()?this.convertToIndexer():this.isKeyIndexer()&&this.convertToKeyIndexer()}isCall(){return this.next&&this.next.is("group")&&this.current.is(["identifier","template"])}convertToCall(){for(this.current.is("template")&&(this.current.tag="template-call");this.next.first;)this.current.add(this.next.first);this.next.orphan()}isIndexer(){return this.next&&this.next.is("array")&&this.currentIsIndexable()}convertToIndexer(){let t=new c("indexer");t.add(this.current),this.next.tag="group",this.next.wrap(t)}isKeyIndexer(){return this.next&&this.next.is("object")&&this.currentIsIndexable()}convertToKeyIndexer(){let t=new c("key-indexer");t.add(this.current),this.next.tag="group",this.next.wrap(t)}currentIsIndexable(){return this.current.is(["literal","identifier","template-call","variable","expression","array","object"])}};var j=class{get stackOperator(){return this.operatorStack[0]&&this.operatorStack[0].operator||null}parse(e){if(this.initialize(),!!j.isExpression(e)){for(let t of e.children){if(this.current=t,this.current.is("operator"))this.parseOperator();else{if(this.last&&!this.last.is("operator"))throw new g("Unexpected token",this.current.sourceRef);this.parseTerm()}this.last=this.current}for(;this.operatorStack.length>0;)this.popOperator()}}initialize(){this.operatorStack=[],this.outputQueue=[],this.current=null,this.last=null}static isExpression(e){return!!e.children.find(t=>t.is("operator"))}parseTerm(){this.outputQueue.push(this.current);let e=this.stackOperator;e&&e.isUnary&&this.popOperator(1)}parseOperator(){this.current.operator&&(this.current.operator.isUnary?this.parseUnary():this.parseBinary())}parseUnary(){this.current.operator.assoc=="right"?(this.current.add(this.outputQueue.pop()),this.outputQueue.push(this.current)):this.operatorStack.unshift(this.current)}parseBinary(){let e=this.current.operator,t=this.stackOperator;for(;t&&t.precedence>=e.precedence&&e.assoc!="right";)this.popOperator(),t=this.stackOperator;this.operatorStack.unshift(this.current)}popOperator(e){e=e||2;let t=this.operatorStack.shift();if(this.outputQueue.length>=e){for(;e--;)t.add(this.outputQueue.pop(),0);this.outputQueue.push(t)}else throw new Error(`Operator "${t.operator.symbol}" expects ${e} operands, ${this.outputQueue.length} given`)}};var ce=class{constructor(e){this.loader=e}parse(e){e.definition=this.loader.getDefinition(e.symbol,e.tag)}};var ue=class extends ae{constructor(e){super({parser:new pe(e),rootFirst:!0},{parser:new le},{parser:new j},{parser:new ce(e)})}};var Fe=class{constructor(e){this.grouper=new se,this.parser=new ue(e)}parse(e){let t=this.grouper.parse(e);return this.parser.parse(t),t.optimize(),Fe.LogExpressions&&console.log(t.toString(!0)),t.validate(),t}},z=Fe;z.LogExpressions=!1;var Le=class{constructor(...e){this.loader=new F(...e),this.parser=new z(this.loader),this.scope=new E}compile(e){let t=new E;t.parentScope=this.scope;let i=this.parser.parse(e);return new ge(i,t)}define(e){this.loader.defineExpression(e)}},ge=class{constructor(e,t){this.inputs={};this.root=e,this.scope=t||new E,this.expr=e.compile(),this.expr.bindScope(this.scope)}evaluate(...e){for(let t of e){let i=this.inputs[t.name];if(i)i.replaceValue(t.value);else{if(t.name==null||!t.name.startsWith("$"))throw new Error("Input variable names must begin with '$'.");let o=new Q(t.name,t.value);this.scope.setVariable(o),this.inputs[t.name]=o}}return this.expr.evaluate()}clearInputs(){this.inputs={},this.scope.clearVariables()}};ve();export{Le as JsonFx};
/*!
JSON-Fx

MIT License

Copyright (c) 2019 Aaron Eads

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/
